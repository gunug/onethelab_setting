# 보안 위험 분석

이 문서는 Supabase Realtime 채팅 시스템의 보안 위험을 분석하고 기록합니다.

## 위험 수준별 분류

### 높음 (High)

| 항목 | 설명 | 영향 | 대응 방안 | 상태 |
|------|------|------|----------|------|
| ~~**클라이언트 측 차단**~~ | ~~메시지 차단이 JavaScript에서만 이루어짐~~ | ~~악의적 사용자가 인증 없이 메시지 열람 가능~~ | ~~Supabase RLS 또는 별도 백엔드 서버 필요~~ | ✅ **해결됨** (v2.0) |
| **`--dangerously-skip-permissions`** | Claude가 프로젝트 디렉토리 내 모든 파일/명령 실행 권한 보유 | 인증된 사용자도 악성 프롬프트로 프로젝트 손상 가능 | 프롬프트 필터링, 위험 명령어 블랙리스트 | ⚠️ 부분 해결 |
| ~~**세션 토큰 평문 전송**~~ | ~~auth_token이 Broadcast로 모든 구독자에게 전송됨~~ | ~~다른 사용자가 토큰 탈취하여 세션 하이재킹 가능~~ | ~~토큰 전송 제거~~ | ✅ **해결됨** (v2.0) |

### 중간 (Medium)

| 항목 | 설명 | 영향 | 대응 방안 | 상태 |
|------|------|------|----------|------|
| ~~**OTP 브루트포스**~~ | ~~인증 시도 횟수 제한 없음~~ | ~~6자리 = 100만 조합, 자동화 공격 가능~~ | ~~IP/사용자별 시도 횟수 제한~~ | ✅ **해결됨** (v2.0) |
| ~~**채널 공개 구독**~~ | ~~누구나 `chat-room` 채널 구독 가능~~ | ~~JavaScript 우회 시 모든 메시지 수신~~ | ~~Supabase RLS 정책 또는 채널 비밀번호~~ | ✅ **해결됨** (v2.0) |
| ~~**TOTP 비밀키 노출**~~ | ~~`.env` 파일에 평문 저장~~ | ~~서버 접근 시 OTP 생성 가능~~ | ~~환경 변수 암호화, 접근 권한 제한~~ | ✅ **해결됨** (v2.0) |
| ~~**시간 동기화**~~ | ~~TOTP는 서버 시간에 의존~~ | ~~서버 시간 조작 시 인증 우회 가능~~ | ~~NTP 동기화 강제, 시간 검증~~ | ✅ **해결됨** (v2.0) |

### 낮음 (Low)

| 항목 | 설명 | 대응 방안 | 상태 |
|------|------|----------|------|
| **localStorage 토큰** | XSS 공격 시 토큰 탈취 가능 | CSP 헤더 설정, 입력 검증 강화 | ⚠️ 미해결 |
| ~~**세션 메모리 저장**~~ | ~~봇 재시작 시 모든 세션 만료 (DoS 가능)~~ | ~~Redis 등 외부 저장소 사용~~ | ✅ **해결됨** (v2.0) |
| **ccusage 명령 노출** | 사용량 정보로 활동 패턴 추론 가능 | 민감 정보 필터링 | ⚠️ 미해결 |

## 근본적 한계

### Supabase Realtime Broadcast 특성

- **서버 측 필터링 불가**: 특정 클라이언트에게만 메시지 전송 불가능
- **전체 브로드캐스트**: 모든 구독자에게 동일한 메시지 전달
- **진정한 서버 측 차단 불가능**: 클라이언트 측 JavaScript 차단만 가능

### 현재 보안 모델의 한계

```
[사용자] → [Supabase Realtime] → [모든 구독자]
                    ↓
            Python 봇 (인증 확인)
                    ↓
            Claude 요청 처리 (인증된 경우만)
```

- 메시지 **수신**은 모든 구독자에게 전달됨
- Claude **요청 처리**만 인증된 사용자로 제한
- 메시지 **표시**는 클라이언트 JavaScript에서 차단 (우회 가능)

## Supabase Auth + MFA 현재 구현 (v2.0)

### 보호되는 기능 (서버 측 검증)
- 채널 접속: Supabase Auth 인증 필수 (이메일/비밀번호 + MFA)
- Claude 요청 처리: 인증된 사용자만 채널 접속 가능
- 세션 리셋 요청: 인증된 사용자만 채널 접속 가능

### 인증 방식
- 이메일/비밀번호 인증 (Supabase Auth)
- MFA 2단계 인증 (Supabase MFA API - TOTP)
- 토큰은 메시지에 포함하지 않음 (Broadcast 노출 방지)

### v2.0에서 개선된 보안
- **클라이언트 측 차단 → 서버 측 인증**: Supabase Auth 인증 없이는 채널 접속 자체 불가
- **채널 공개 구독 → 인증 필수**: 이메일/비밀번호 + MFA 인증된 사용자만 채널 구독 가능
- **OTP 브루트포스 방지**: Supabase Auth에서 자체적으로 시도 횟수 제한 적용
- **TOTP 비밀키 관리**: Supabase 서버에서 관리, 로컬 `.env` 파일에 저장하지 않음
- **시간 동기화**: Supabase 서버 시간 사용, 클라이언트 시간과 무관
- **세션 관리**: Supabase Auth 세션, 봇 재시작과 무관하게 유지
- **토큰 평문 전송 제거**: 메시지에 auth_token을 포함하지 않음, Supabase Auth 인증 의존

## 권장 조치

### 즉시 적용 가능

1. ~~**OTP 브루트포스 방지**~~ ✅ **해결됨** (v2.0 - Supabase Auth 자체 제한)
   - ~~IP/사용자별 시도 횟수 제한~~
   - ~~실패 시 지수 백오프 적용~~

2. **Claude 권한 제한** ⚠️ 미해결
   - CLAUDE.md에 허용된 디렉토리 명시
   - 위험한 명령어 블랙리스트

3. **민감 정보 필터링** ⚠️ 미해결
   - Claude 응답에서 시스템 경로, API 키 등 제거

### 구조적 개선 (선택사항)

1. **Supabase RLS 활용**
   - 데이터베이스 기반 메시지 저장
   - Row Level Security로 접근 제어

2. **개별 채널 사용**
   - 사용자별 개인 채널 생성
   - 민감 정보는 개인 채널로만 전송

## 현실적인 보안 전략

현재 구조에서 **완전한 보안은 불가능**합니다.

**권장 운영 방식:**
- Supabase Auth에 등록된 사용자만 접근 가능 (이메일/비밀번호 + MFA)
- Railway 배포 시 접근 URL을 공개하지 않음
- Supabase 대시보드에서 사용자 관리
- Claude 응답 모니터링

## 해결 현황 요약

| 분류 | 총 항목 | 해결됨 | 미해결 |
|------|---------|--------|--------|
| 높음 (High) | 3 | 2 | 1 |
| 중간 (Medium) | 4 | 4 | 0 |
| 낮음 (Low) | 3 | 1 | 2 |
| **합계** | **10** | **7** | **3** |

## 버전 이력

- **2026-01-30**: v2.0 기준 업데이트 (Supabase Auth + MFA 적용, 해결된 항목 표시)
- **2026-01-30**: 최초 작성 (v1.3 기준)
